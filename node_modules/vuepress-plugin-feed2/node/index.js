"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("@mr-hope/vuepress-shared"),e=require("chalk"),r=require("path"),a=require("fs-extra");function o(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(r){if("default"!==r){var a=Object.getOwnPropertyDescriptor(t,r);Object.defineProperty(e,r,a.get?a:{enumerable:!0,get:function(){return t[r]}})}})),e.default=t,Object.freeze(e)}var n=o(require("xml-js"));const i=new t.Logger("Feed"),s=t=>t.replace(/ class=".*?"/gu,"").replace(/ v-pre/gu,"").replace(/<a href="#.*?">.*?<\/a>/gu,"").replace(/<!--.*?-->/gu,"").replace(/<OutboundLink ?\/>/gu,"").replace(/<RouterLink to="(.*?)">(.*?)<\/RouterLink>/gu,'<a href="$1">$2</a>').replace(/<(?:a|div|span)[^>]*?\/>/gu,"").replace(/<(Badge|FlowChart|Presentation).*?(?:>.*?<\/\1>|\/>)/gu,"<i>Content not supported</i>").replace(/<math[\s\S]*?\/math>/gu,"<i>Content not supported</i>"),c=(t,e="",r="")=>`${t}${e.replace(/^\/?/u,"/").replace(/\/?$/u,"/")}${r.replace(/^\//u,"")}`,p=(t="")=>`image/${"jpg"===t?"jpeg":"svg"===t?"svg+xml":"jpeg"===t||"png"===t||"bmp"===t||"gif"===t||"webp"===t?t:""}`,u=e=>t.deepAssign({atom:{enable:!0,path:"atom.xml"},json:{enable:!0,path:"feed.json"},rss:{enable:!0,path:"rss.xml"}},e||{}),h=e=>{const{name:r,email:a,url:o}=e;return{name:r,...a?{email:a}:{},...o?{uri:t.encodeXML(o)}:{}}},l=t=>{const{name:e,scheme:r}=t;return{_attributes:{term:e,scheme:r}}},d=t=>({name:t.name,...t.url?{url:t.url}:{},...t.avator?{avator:t.avator}:{}}),g=t=>{const{name:e,domain:r}=t;return{_text:e,...r?{_attributes:{domain:r}}:{}}},m=e=>{const r=e.guid||t.encodeXML(e.link);return{...t.isUrl(r)?{}:{_attributes:{isPermaLink:!1}},_text:r}};class f{options;items=[];categories=new Set;_contributorKeys=new Set;contributors=[];constructor(t){this.options=t}addItem=t=>{this.items.push(t)};addCategory=t=>{this.categories.add(t)};addContributor=t=>{const e=t.email||t.name;e&&!this._contributorKeys.has(e)&&(this._contributorKeys.add(e),this.contributors.push(t))};atom=()=>(e=>{const{channel:r,links:a}=e.options,o={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...r.language?{"xml:lang":r.language}:{}},id:r.link,title:r.title,...r.description?{subtitle:r.description}:{},...r.author?{author:h(r.author)}:{},updated:r.lastUpdated?r.lastUpdated.toISOString():(new Date).toISOString(),generator:"vuepress-plugin-feed2",link:[{_attributes:{rel:"self",href:t.encodeXML(a.atom)}}]}};return r.link&&o.feed.link.push({_attributes:{rel:"alternate",href:t.encodeXML(r.link)}}),r.hub&&o.feed.link.push({_attributes:{rel:"hub",href:t.encodeXML(r.hub)}}),r.image&&(o.feed.logo=r.image),r.icon&&(o.feed.icon=r.icon),r.copyright&&(o.feed.rights=r.copyright),o.feed.category=Array.from(e.categories).map((t=>({_attributes:{term:t}}))),o.feed.contributor=Array.from(e.contributors).filter((t=>t.name)).map((t=>h(t))),o.feed.entry=e.items.map((e=>{const r={title:{_attributes:{type:"html"},_text:t.encodeXML(e.title)},id:t.encodeXML(e.guid||e.link),link:{_attributes:{href:t.encodeXML(e.link)}},updated:e.lastUpdated.toISOString()};return e.description&&(r.summary={_attributes:{type:"html"},_cdata:t.encodeCDATA(e.description)}),e.content&&(r.content={_attributes:{type:"html"},_cdata:t.encodeCDATA(e.content)}),Array.isArray(e.author)?r.author=e.author.filter((t=>t.name)).map((t=>h(t))):e.author&&e.author.name&&(r.author=[h(e.author)]),Array.isArray(e.category)?r.category=e.category.map((t=>l(t))):e.category&&(r.category=[l(e.category)]),Array.isArray(e.contributor)&&(r.contributor=e.contributor.map((t=>h(t)))),e.pubDate&&(r.published=e.pubDate.toISOString()),e.copyright&&(r.rights=e.copyright),r})),n.js2xml(o,{compact:!0,ignoreComment:!0,spaces:2})})(this);rss=()=>(e=>{const{links:r,channel:a}=e.options;let o=!1;const i={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:r.rss,rel:"self",type:"application/rss+xml"}},title:{_text:a.title},link:{_text:t.encodeXML(a.link)},description:{_text:a.description},language:{_text:t.encodeXML(a.language)},pubDate:{_text:a.pubDate?a.pubDate.toUTCString():(new Date).toUTCString()},lastBuildDate:{_text:a.lastUpdated?a.lastUpdated.toUTCString():(new Date).toUTCString()},generator:{_text:"vuepress-plugin-feed2"},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return a.copyright&&(i.rss.channel.copyright={_text:a.copyright}),a.ttl&&(i.rss.channel.ttl={_text:a.ttl.toString()}),a.image&&(i.rss.channel.image={title:{_text:a.title},url:{_text:a.image},link:{_text:t.encodeXML(a.link)}}),i.rss.channel.category=Array.from(e.categories).map((t=>({_text:t}))),i.rss.channel.item=e.items.map((e=>{const a={title:{_text:t.encodeXML(e.title)},link:{_text:t.encodeXML(e.link)},guid:m(e),source:{_attributes:{url:r.rss},_text:e.title}};if(e.description&&(a.description={_text:t.encodeXML(e.description)}),Array.isArray(e.author)){const t=e.author.find((t=>t.email&&t.name));t&&(a.author={_text:`${t.email} (${t.name})`})}else if("object"==typeof e.author){const{name:t,email:r}=e.author;r&&t&&(a.author={_text:`${r} (${t})`})}var n;return Array.isArray(e.category)?a.category=e.category.filter((t=>t.name)).map((t=>g(t))):"object"==typeof e.category&&e.category.name&&(a.category=[g(e.category)]),e.comments&&(a.comments={_text:t.encodeXML(e.link)}),e.pubDate&&(a.pubDate={_text:e.pubDate.toUTCString()}),e.content&&(o=!0,a["content:encoded"]={_cdata:t.encodeCDATA(e.content)}),e.enclosure&&(a.enclosure={_attributes:{url:(n=e.enclosure).url,...n.length?{length:n.length}:{},...n.type?{type:n.type}:{}}}),a})),o&&(i.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",i.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),n.js2xml(i,{compact:!0,ignoreComment:!0,spaces:2})})(this);json=()=>(t=>{const{channel:e,links:r}=t.options,a={version:"https://jsonfeed.org/version/1.1",title:e.title,home_page_url:e.link,feed_url:r.json};return e.description&&(a.description=e.description),e.image&&(a.icon=e.image),e.icon&&(a.favicon=e.icon),e.author?.name&&(a.author={name:e.author.name,...e.author.url?{url:e.author.url}:{},...e.author.avator?{avator:e.author.avator}:{}}),a.items=t.items.map((t=>{const e={title:t.title,url:t.link,id:t.guid||t.link,...t.description?{summary:t.description}:{},content_html:t.content};return t.image&&(e.image=t.image),t.pubDate&&(e.date_published=t.pubDate.toISOString()),t.lastUpdated&&(e.date_modified=t.lastUpdated.toISOString()),Array.isArray(t.author)?e.authors=t.author.filter((t=>t.name)).map((t=>d(t))):"object"==typeof t.author&&(e.authors=[d(t.author)]),Array.isArray(t.category)?e.tags=t.category.filter((t=>t.name)).map((t=>t.name)):t.category&&(e.tags=[t.category.name]),e})),JSON.stringify(a,null,2)})(this)}class y{page;feed;options;app;feedOption;frontmatter;base;themeConfig;constructor(t,e,r,a){this.page=t,this.feed=e,this.options=r,this.app=a,this.frontmatter=t.frontmatter,this.feedOption=this.frontmatter.feed||{},this.base=this.app.options.base,this.themeConfig=this.app.options.themeConfig}get title(){return this.feedOption.title||this.page.title}get link(){return c(this.options.hostname,this.base,this.page.path)}get description(){return this.feedOption.description?this.feedOption.description:this.frontmatter.description?this.frontmatter.description:this.page.excerpt?s(this.app.markdown.render(this.page.excerpt)):void 0}get author(){return Array.isArray(this.feedOption.author)?this.feedOption.author:"object"==typeof this.feedOption.author?[this.feedOption.author]:!1===this.frontmatter.author?[]:t.getAuthor(this.frontmatter,this.themeConfig).map((t=>({name:t})))}get category(){if(Array.isArray(this.feedOption.category))return this.feedOption.category;if("object"==typeof this.feedOption.category)return[this.feedOption.category];const{categories:e,category:r=e}=this.frontmatter;return t.getCategory(r).map((t=>({name:t})))}get enclosure(){if(this.image)return{url:this.image,type:p(this.image.split(".").pop())}}get guid(){return this.feedOption.guid||this.link}get pubDate(){const{time:t,date:e=t}=this.page.frontmatter,{createdTime:r}=this.page.git||{};return e&&e instanceof Date?e:r?new Date(r):void 0}get lastUpdated(){const{updatedTime:t}=this.page.git||{};return t?new Date(t):new Date}get content(){return this.feedOption.content?this.feedOption.content:s(this.page.componentFileContent.replace(/<template>.*<\/template>/,"$1"))}get image(){const{banner:e,cover:r}=this.frontmatter;if(e){if(t.isAbsoluteUrl(e))return c(this.options.hostname,this.app.options.base,e);if(t.isUrl(e))return e}if(r){if(t.isAbsoluteUrl(r))return c(this.options.hostname,this.app.options.base,r);if(t.isUrl(r))return r}const a=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(a){if(t.isAbsoluteUrl(a[1]))return c(this.options.hostname,this.app.options.base,a[1]);if(t.isUrl(a[1]))return a[1]}}get contributor(){return Array.isArray(this.feedOption.contributor)?this.feedOption.contributor:"object"==typeof this.feedOption.contributor?[this.feedOption.contributor]:this.author}get copyright(){if(this.frontmatter.copyrightText)return this.frontmatter.copyrightText;const t=this.author[0];return t&&t.name?`Copyright by ${t.name}`:void 0}getFeedItem(){const{author:t,category:e,content:r,contributor:a,copyright:o,description:n,enclosure:i,guid:s,image:c,lastUpdated:p,link:u,pubDate:h,title:l}=this;return!(!l&&!n)&&(e&&e.forEach((t=>this.feed.addCategory(t.name))),a&&a.forEach((t=>this.feed.addContributor(t))),{title:l,link:u,description:n,author:t,category:e,enclosure:i,guid:s,pubDate:h,lastUpdated:p,content:r,image:c,contributor:a,copyright:o})}}class b{pages;options;app;feed;constructor(t,e,r,a){this.pages=t,this.options=e,this.app=a,this.feed=new f(r)}addPages(){let t=0;const r=this.pages.slice(0,this.options.count);for(const e of r){const r=new y(e,this.feed,this.options,this.app).getFeedItem();r&&(this.feed.addItem(r),t+=1)}i.success(`added ${e.cyan(`${t} page(s)`)} as feed item(s)`)}async generateFeed(){const{dest:t}=this.app.dir,o=u(this.options.output);this.addPages();const n=i.load("Generating Feed...");if(o.atom.enable){const n=t(o.atom.path);await a.outputFile(n,this.feed.atom()),i.success(`Atom feed file generated and saved to ${e.cyan(r.relative(__dirname,n))}`)}if(o.json.enable){const n=t(o.json.path);await a.outputFile(n,this.feed.json()),i.success(`JSON feed file generated and saved to ${e.cyan(r.relative(__dirname,n))}`)}if(o.rss.enable){const n=t(o.rss.path);await a.outputFile(n,this.feed.rss()),i.success(`RSS feed file generated and saved to ${e.cyan(r.relative(__dirname,n))}`)}n.succeed()}}exports.default=(e,r)=>{const a=((e,r)=>{const{themeConfig:a}=r.options,o=e.hostname||a.hostname;return o?(e.hostname=o.replace(/\/?$/u,""),e.rootLang=t.getRootLang(r),e):(i.error("Option 'hostname' is required!"),!1)})(e,r);if(!a)return{};const o=((e,r)=>{const{rootLang:a,hostname:o,icon:n,image:i}=e,{base:s,themeConfig:p}=r.options,{title:u,description:h}=r.siteData,l=e.channel?.author?.name||p.author,d=p?.footer?.copyright||(l?`Copyright by ${l}`:""),g={title:u,link:c(o,s),description:h,language:a,copyright:d,pubDate:new Date,lastUpdated:new Date,...n?{icon:n}:{},...i?{image:i}:{},...l?{author:{name:l}}:{}};return t.deepAssign(g,e.channel||{})})(a,r),n=u(a.output),s=((t,e,r)=>{const{base:a}=r.options,{hostname:o}=t;return{atom:c(o,a,e.atom.path),json:c(o,a,e.json.path),rss:c(o,a,e.rss.path)}})(a,n,r),p=[];return{name:"feed2",extendsPageData(t){var e;a.filter&&("function"!=typeof a.filter||!a.filter(t)||((e=t.frontmatter).home||!1===e.article||e.feed&&!1===e.feed.enable))||p.push(t)},onPrepared(){((t,e)=>{const r=u(t.output),{base:a}=e.options,{siteData:o}=e,n=(e,r,n)=>["link",{rel:"alternate",type:n,href:c(t.hostname,a,r),title:`${o.title||""} ${e} Feed`}];o.head||(o.head=[]),r.atom.enable&&o.head.push(n("Atom",r.atom.path,"application/atom+xml")),r.json.enable&&o.head.push(n("JSON",r.json.path,"application/json")),r.rss.enable&&o.head.push(n("RSS",r.rss.path,"application/rss+xml"))})(a,r)},async onGenerated(){const t=("function"==typeof a.sort?p.sort(a.sort):p).slice(0,a.count);await new b(t,a,{channel:o,links:s},r).generateFeed()}}};
//# sourceMappingURL=index.js.map
